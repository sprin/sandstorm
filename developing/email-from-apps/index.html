<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Email from apps - Sandstorm</title>
  

  <link rel="shortcut icon" href="../../img/favicon.ico">

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">

  
  <script>
    // Current page data
    var mkdocs_page_name = "Email from apps";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script>
  <script src="../../js/theme.js"></script> 
  <script src="../../analytics.js"></script>

  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Sandstorm</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../..">Home</a>
        
    </li>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Using</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../using/">Overview</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../guided-tour/">Guided tour</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../using/top-bar/">Top bar</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../using/how-it-works/">How it works</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../using/security-practices/">Security practices</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Developing apps</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../">Overview</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../vagrant-spk/">Overview of vagrant-spk</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../vagrant-spk/installation/">Installation</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../vagrant-spk/packaging-tutorial/">Packaging tutorial</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../vagrant-spk/packaging-tutorial-meteor/">Packaging tutorial (Meteor)</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../publishing-apps/">App publishing guide</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../handbook/">App Developer Handbook</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../auth/">User authentication & permissions</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../path/">Paths and URLs</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../vagrant-spk/customizing/">Understanding & customizing</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../vagrant-spk/platform-stacks/">Platform stacks</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../vagrant-spk/code-dependencies/">Code dependencies</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../vagrant-spk/services/">Service dependencies</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../web-publishing/">Web publishing</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../http-apis/">Exporting HTTP APIs</a>
        
    </li>

        
            
    <li class="toctree-l1 current">
        <a class="current" href="./">Email from apps</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#using-email-from-your-sandstorm-app">Using email from your Sandstorm app</a></li>
                
                    <li><a class="toctree-l4" href="#note-provisional-api">Note: Provisional API</a></li>
                
                    <li><a class="toctree-l4" href="#overview">Overview</a></li>
                
                    <li><a class="toctree-l4" href="#using-sandstorm-http-bridge">Using sandstorm-http-bridge</a></li>
                
                    <li><a class="toctree-l4" href="#using-hacksessionhacksessioncontext">Using HackSession/HackSessionContext</a></li>
                
            
            </ul>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../vagrant-spk/design/">vagrant-spk design document</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../troubleshooting/">Troubleshooting</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Developing on raw Sandstorm</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../raw-packaging-guide/">Raw packaging guide</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../raw-python/">Raw integration of Python</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../raw-ruby-on-rails/">Raw integration of Ruby on Rails</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../raw-pure-client-apps/">Raw integration of pure client apps</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Administering</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../administering/">Overview</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../install/">Installation</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../administering/sandcats/">Sandcats dynamic DNS</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../administering/email/">Email</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../administering/demo/">Demo mode</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../administering/backups/">Backups</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../administering/wildcard/">Wildcard hosts</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../administering/reverse-proxy/">Reverse Proxy</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../administering/ssl/">HTTPS & SSL</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../administering/faq/">Frequently asked questions</a>
        
    </li>

        
    </ul>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Sandstorm</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Developing apps &raquo;</li>
        
      
    
    <li>Email from apps</li>
    <li class="wy-breadcrumbs-aside">
      
        
          <a href="https://github.com/sandstorm-io/sandstorm/tree/master/docs" class="icon icon-github"> Edit on GitHub</a>
        
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="using-email-from-your-sandstorm-app">Using email from your Sandstorm app</h1>
<p>Using e-mail in your Sandstorm app is accomplished through the Cap'n
Proto interfaces defined in
<a href="https://github.com/sandstorm-io/sandstorm/blob/master/src/sandstorm/hack-session.capnp">hack-session.capnp</a>
and
<a href="https://github.com/sandstorm-io/sandstorm/blob/master/src/sandstorm/email.capnp">email.capnp</a>. This
becomes a little more complicated if you're using
sandstorm-http-bridge in your app (as most apps do), since you don't
have direct access to the HackSession/HackSessionContext. Below, we
will go over using either sandstorm-http-bridge or using the
HackSession directly.</p>
<h2 id="note-provisional-api">Note: Provisional API</h2>
<p>The current implementation of e-mail is hacky and not intended to be
the long-term solution. In the long term, users will be able to
connect e-mail addresses to their Sandstorm account and then grant
them to apps as capabilities through the Powerbox UI. Since the
Powerbox and persistent capabilities are not yet implemented -- much
less the ability to connect e-mails -- we are providing a hack so that
developers can get started on such apps now. The hack involves
assigning a randomly-generated e-mail address to each app instance
that wants e-mail, but also allowing the "From" header to be set to
any e-mail address that the user has proven they own.</p>
<h2 id="overview">Overview</h2>
<p>When you launch an e-mail application on Sandstorm, it is assigned a
random e-mail address at your server, like
"JBuaKxjkwiJq7oksS@alpha.sandstorm.io". Any e-mail sent to that
address is delivered to the app. The idea is not that you'd actually
use this address publicly, but rather that you should set up e-mail
forwarding from your real address to this address. For example, GMail
allows you to set up such forwarding while still keeping a copy in
your GMail inbox, and even lets you do the forwarding conditionally
based on a filter.  Additionally, most domain registrars have the
ability to set up basic e-mail forwarding, so if you have your own
domain, it's easy to set up an address that redirects to a Sandstorm
app.</p>
<p>When you send e-mail from a Sandstorm app, we allow you to set the
"From" header either to your app's random address or to your verified
Sandstorm login address. In the future, we'd like to add the ability
to attach additional verified addresses to your account. Either way,
the message's envelope return address is always the app's address. As
a result, the mail recipient may see that the message was sent "via"
your server.</p>
<p>In order to prevent abuse, E-mail usage is rate-limited
per-user. Currently, the limits default to 50 messages per day and no
more than 20 recipients on any one message. We'd like to loosen these
limits in the future by doing more careful abuse monitoring.</p>
<h2 id="using-sandstorm-http-bridge">Using sandstorm-http-bridge</h2>
<h3 id="receiving">Receiving</h3>
<p>In this case, receipt of e-mails is already handled for you. Upon your
grain receiving an e-mail, it will be written to <code>/var/mail/new</code>. This
follows the <a href="https://en.wikipedia.org/wiki/Maildir">maildir</a>
convention, and many e-mail apps will be able to use this out of the
box.</p>
<h3 id="sending">Sending</h3>
<p>Sending e-mails is a bit more tricky. For now, you have to use the
Cap'n Proto
<a href="https://github.com/sandstorm-io/sandstorm/blob/master/src/sandstorm/hack-session.capnp"><code>HackSessionContext</code></a>
interface that is re-exported by
sandstorm-http-bridge. sandstorm-http-bridge creates a socket at
<code>/tmp/sandstorm-api</code> and exports a bootstrap
<a href="https://github.com/sandstorm-io/sandstorm/blob/master/src/sandstorm/sandstorm-http-bridge.capnp"><code>SandstormHttpBridge</code></a>
capability on it. You will need to call <code>getSessionContext()</code> with the
ID that sandstorm-http-bridge places in the <code>X-Sandstorm-Session-Id</code>
header. The result will be a <code>SessionContext</code> that can be cast to a
<code>HackSessionContext</code>. For example, using pycapnp, you can get the
<code>HackSessionContext</code> as follows:</p>
<pre><code class="python">import socket
import sys
import capnp
import sandstorm_http_bridge_capnp
import hack_session_capnp

# Assume that we were passed the session ID as a commandline argument.
session_id = sys.argv[1]

s = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)
s.connect(&quot;/tmp/sandstorm-api&quot;)

client = capnp.TwoPartyClient(s)
bridge = client.ez_restore().cast_as(sandstorm_http_bridge_capnp.SandstormHttpBridge)
session_context = bridge.get_session_context({&quot;id&quot; : session_id}).wait().context
email_cap = session_context.cast_as(hack_session_capnp.HackSessionContext)
</code></pre>

<p>Now that you have a HackSessionContext, just follow the directions
below under <a href="#sending-with-hacksessioncontext">Sending with
HackSessionContext</a>.</p>
<h2 id="using-hacksessionhacksessioncontext">Using HackSession/HackSessionContext</h2>
<h3 id="receiving-through-hacksession">Receiving through HackSession</h3>
<p>Your <code>UIView.newSession</code> method (refer to
<a href="https://github.com/sandstorm-io/sandstorm/blob/master/src/sandstorm/grain.capnp">grain.capnp</a>) must return a
HackEmailSession. In your HackEmailSession capability, you must
implement the <code>send</code> method, which will be called whenever an e-mail
is sent to the grain.</p>
<h3 id="sending-with-hacksessioncontext">Sending with HackSessionContext</h3>
<p>A HackSessionContext is obtained upon call of <code>UIView.newSession</code>
(refer to
<a href="https://github.com/sandstorm-io/sandstorm/blob/master/src/sandstorm/grain.capnp">grain.capnp</a>). You will be
passed a HackSessionContext as the 2nd paramater, and it is up to your
app to store/use it.</p>
<p>Now that you have the HackSessionContext, sending e-mails is easy:</p>
<pre><code class="python">req = email_cap.send_request()
email = req.email

# only getUserAddress() or the grain's public address are allowed here
# use setattr to deal with 'from' being a reserved keyword in Python
setattr(email, 'from', email_cap.getUserAddress().wait())
email.to = {address: 'example@example.com'}
email.subject = 'Example e-mail'
email.text = 'This is an example e-mail'

req.send().wait()
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../vagrant-spk/design/" class="btn btn-neutral float-right" title="vagrant-spk design document"/>Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../http-apis/" class="btn btn-neutral" title="Exporting HTTP APIs"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a class="icon icon-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../http-apis/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../../vagrant-spk/design/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>

</body>
</html>
