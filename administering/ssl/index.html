<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>HTTPS & SSL - Sandstorm</title>
  

  <link rel="shortcut icon" href="../../img/favicon.ico">

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">

  
  <script>
    // Current page data
    var mkdocs_page_name = "HTTPS & SSL";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script>
  <script src="../../js/theme.js"></script> 
  <script src="../../analytics.js"></script>

  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Sandstorm</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../..">Home</a>
        
    </li>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Using</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../using/">Overview</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../guided-tour/">Guided tour</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../using/top-bar/">Top bar</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../using/how-it-works/">How it works</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../using/security-practices/">Security practices</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Developing apps</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../developing/">Overview</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../vagrant-spk/">Overview of vagrant-spk</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../vagrant-spk/installation/">Installation</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../vagrant-spk/packaging-tutorial/">Packaging tutorial</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../vagrant-spk/packaging-tutorial-meteor/">Packaging tutorial (Meteor)</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../developing/publishing-apps/">App publishing guide</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../developing/handbook/">App Developer Handbook</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../developing/auth/">User authentication & permissions</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../developing/path/">Paths and URLs</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../vagrant-spk/customizing/">Understanding & customizing</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../vagrant-spk/platform-stacks/">Platform stacks</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../vagrant-spk/code-dependencies/">Code dependencies</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../vagrant-spk/services/">Service dependencies</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../developing/web-publishing/">Web publishing</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../developing/http-apis/">Exporting HTTP APIs</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../developing/email-from-apps/">Email from apps</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../vagrant-spk/design/">vagrant-spk design document</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../developing/troubleshooting/">Troubleshooting</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Developing on raw Sandstorm</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../developing/raw-packaging-guide/">Raw packaging guide</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../developing/raw-python/">Raw integration of Python</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../developing/raw-ruby-on-rails/">Raw integration of Ruby on Rails</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../developing/raw-pure-client-apps/">Raw integration of pure client apps</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Administering</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../">Overview</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../install/">Installation</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../sandcats/">Sandcats dynamic DNS</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../email/">Email</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../demo/">Demo mode</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../backups/">Backups</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../wildcard/">Wildcard hosts</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../reverse-proxy/">Reverse Proxy</a>
        
    </li>

        
            
    <li class="toctree-l1 current">
        <a class="current" href="./">HTTPS & SSL</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#sandstorm-and-https">Sandstorm and HTTPS</a></li>
                
                    <li><a class="toctree-l4" href="#sandstorms-built-in-https-if-you-use-a-sandcatsio-domain">Sandstorm's built-in HTTPS (if you use a sandcats.io domain)</a></li>
                
                    <li><a class="toctree-l4" href="#technical-details">Technical details</a></li>
                
            
                <li class="toctree-l3"><a href="#self-hosted-https-with-a-custom-certificate-authority">Self-hosted HTTPS with a custom certificate authority</a></li>
                
            
            </ul>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../faq/">Frequently asked questions</a>
        
    </li>

        
    </ul>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Sandstorm</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Administering &raquo;</li>
        
      
    
    <li>HTTPS & SSL</li>
    <li class="wy-breadcrumbs-aside">
      
        
          <a href="https://github.com/sandstorm-io/sandstorm/tree/master/docs" class="icon icon-github"> Edit on GitHub</a>
        
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h2 id="sandstorm-and-https">Sandstorm and HTTPS</h2>
<p>If you are using a hostname like <code>example.sandcats.io</code>, then you
likely already have working HTTPS (SSL) for your hostname. Keep
reading to learn how this feature works and enable it/disable it.</p>
<p>This page also documents other options for HTTPS for a Sandstorm
server.</p>
<h3 id="sandstorms-built-in-https-if-you-use-a-sandcatsio-domain">Sandstorm's built-in HTTPS (if you use a <code>sandcats.io</code> domain)</h3>
<p>For new Sandstorm installations, HTTPS is enabled by
default. Sandstorm listens on port 443 for HTTPS connections and port
80 for HTTP connections.</p>
<p>This is implemented through the <code>sandstorm.conf</code> file. HTTPS mode is
enabled by setting the <code>HTTPS_PORT=443</code> configuration option, causing
the Sandstorm software on your server to bind port 443.</p>
<p>Sandstorm also listens on port 80 (via <code>PORT=80</code>). When there is a
<code>HTTPS_PORT</code> configured, and a request comes in for the Sandstorm
shell or a wildcard host over HTTP, Sandstorm delivers a redirect to
HTTPS.</p>
<p>Sandstorm grains can publish static content to the web on whatever
domain the user wants. Sandstorm serves this static publishing over
both HTTP and HTTPS, since Sandstorm software can't currently get a
valid HTTPS certificate for all domain names.</p>
<h4 id="enabling-https-for-an-existing-sandcatsio-sandstorm-server">Enabling HTTPS for an existing <code>sandcats.io</code> Sandstorm server</h4>
<p>If you are using the <code>sandcats.io</code> DNS service, you can migrate from
running Sandstorm on port 6080 (perhaps with a reverse-proxy) to
having Sandstorm own port 443 (HTTPS) and port 80 (HTTP).</p>
<p>If you are using nginx to speak HTTPS on port 443 and HTTP on port 80,
you should disable that before proceeding.</p>
<p>In this example, we presume your server is on
<em>example.sandcats.io</em>. We also assume your Sandstorm server runs on
port 6080 currently.</p>
<p>This process will require reconfiguring any OAuth login providers like
Google or GitHub, so it may take you up to thirty minutes to complete.</p>
<p>First, enable HTTPS by modifying your Sandstorm configuration file.
One way to do that is to open it with nano:</p>
<pre><code class="bash">sudo nano -w /opt/sandstorm/sandstorm.conf
</code></pre>

<p>Add <code>HTTPS_PORT=</code> to the bottom of the file:</p>
<pre><code class="bash">HTTPS_PORT=443
</code></pre>

<p>Find these settings and modify them:</p>
<pre><code class="bash">BASE_URL=https://example.sandcats.io
WILDCARD_HOST=*.example.sandcats.io
PORT=80,6080
</code></pre>

<p><strong>Note on customization:</strong> if you stick to the default <code>HTTPS_PORT</code> of
443, make sure to remove <code>:6080</code> from <code>BASE_URL</code> and
<code>WILDCARD_HOST</code>. If you prefer a non-default port, you must specify it
in <code>BASE_URL</code> and <code>WILDCARD_HOST</code>. If you want Sandstorm to listen for
HTTP on ports other than 80, you can customize the <code>PORT=</code> line.</p>
<p>Save the file and exit your editor. If you are using <code>nano</code> you can
do this <code>Ctrl-w</code> then <code>enter</code> then <code>Ctrl-x</code>.</p>
<p>Stop and start Sandstorm:</p>
<pre><code class="bash">sudo sandstorm restart
</code></pre>

<p>Sandstorm will begin to set up HTTPS, and if you want to watch the
process, you can run this command:</p>
<pre><code class="bash">sudo tail -f /opt/sandstorm/var/log/sandstorm.log
</code></pre>

<p>The first launch with HTTPS enabled may take one or two minutes while
Sandstorm configures keys.</p>
<p><strong>Note on login providers</strong>: If you had Google or GitHub login enabled
(or other OAuth providers), the change in <code>BASE_URL</code> means that you
need to reconfigure those services. You can log into Sandstorm in a
special admin mode by running:</p>
<pre><code class="bash">sudo sandstorm admin-token
</code></pre>

<p>Once you are viewing the admin page, you should disable and then
re-enable GitHub, Google, and any other OAuth-based login
providers. This process will typically require visiting the Google and
GitHub websites.</p>
<p>Once you click <strong>Save</strong> at the bottom of the login configuration page,
you should sign in however you normally sign in, perhaps with a Google
or GitHub account, by clicking <strong>Sign in</strong>.</p>
<p><strong>Congratulations!</strong> You're now using HTTPS, also known as SSL and TLS.</p>
<h3 id="technical-details">Technical details</h3>
<p><strong>Automatic renewal.</strong> Sandstorm's built-in HTTPS uses the
<a href="../sandcats/">Sandcats.io service</a> to renew certificates without
needing any manual intervention.</p>
<!--
**B rating.** Sandstorm's HTTPS cipher suites are kind of OK but really
could be better.
-->

<p><strong>No reverse proxy.</strong> This configuration removes the need for a
reverse proxy or HTTPS terminator like <code>nginx</code>. If you want to set up
a reverse proxy, you would typically use <code>BIND_IP=127.0.0.1</code> and
<code>PORT=6080</code> and choose a <code>BASE_URL</code> that reflects your external URL.</p>
<p><strong>Server Name Indication (SNI) is required.</strong> Sandstorm's built-in
HTTPS support requires its clients to support Server Name Indication
(SNI), which at the time of writing is supported by [over 97% of web
clients[(http://caniuse.com/#feat=sni).  This is because Sandstorm
relies on nodejs's <code>SNICallback</code> API to smoothly start using new
certificates without restarting the server. Therefore, Sandstorm's
built-in HTTPS support presents an invalid certificate for
<code>client-does-not-support-sni.sandstorm-requires-sni.invalid</code> to
clients that can't speak SNI to clarify that SNI is required. If you
need your Sandstorm installation to support non-SNI clients, you will
need to use a custom HTTPS teminator, or file a bug against Sandstorm.</p>
<p><strong>Duplicate content on multiple ports.</strong> If you are publishing content
at <code>example.com</code> and specify multiple values for <code>PORT=</code>, the content
is available on each port. We used to be concerned that this might
negatively affect how sites hosted on Sandstorm are ranked in search
engines; our research on <a href="https://support.google.com/webmasters/answer/66359?hl=en">how duplicate content is handled by search
engines</a>
reassures us that this will not be a problem. In the long run,
consider turning off port 6080 by removing it from the <code>PORT=</code> line.
If you think the Sandstorm code should support some customization on
how it handles multiple ports, please file a bug so we can make sure
we're serving your needs.</p>
<h2 id="self-hosted-https-with-a-custom-certificate-authority">Self-hosted HTTPS with a custom certificate authority</h2>
<p>The following is a process for self-hosted instances of Sandstorm to use SSL with sandcats.io DNS. These steps create a Certificate Authority (CA), corresponding CA Certificate, and the private and public keys for the <code>[anything].sandcats.io</code> and <code>*.[anything].sandcats.io</code> domains.</p>
<p><strong>Note</strong>: Web browsers will display a big red certificate error when you try to connect to this install. This tutorial is appropriate if you are OK with reconfiguring web browsers to trust a custom certificate authority that you will create during this tutorial. For automatically-trusted SSL configuration, you will need to use a sandcats.io hostname or follow instructions from a certificate authority.</p>
<ol>
<li>
<p><strong>Make a copy openssl.cnf:</strong></p>
<pre><code>cp /etc/ssl/openssl.cnf [directory_you_want_copy_to_be]
</code></pre>
</li>
<li>
<p><strong>Add the following to the end of the copied <code>openssl.cnf</code> file:</strong></p>
<pre><code>[req]
req_extensions = v3_req

[ v3_req ]

# Extensions to add to a certificate request

basicConstraints = CA:FALSE
keyUsage = nonRepudiation, digitalSignature, keyEncipherment
subjectAltName = @alt_names

[alt_names]
DNS.1 = [your-domain-name].sandcats.io
DNS.2 = *.[your-domain-name].sandcats.io
</code></pre>
</li>
<li>
<p><strong>Create the Certificate Authority (CA) Key:</strong></p>
<pre><code>openssl genrsa -out rootCA.key 4096
</code></pre>
<p><code>rootCA.key</code> is the file for the Certificate Authority (CA) key.</p>
</li>
<li>
<p><strong>Sign the Certificate Authority (CA) Key and Create Certificate Authority (CA) certificate (Expires in 10 years):</strong></p>
<pre><code>openssl req -x509 -new -nodes -key rootCA.key -days 3650 -out rootCA.pem
</code></pre>
<p><code>rootCA.pem</code> is the file for the Certificate Authority (CA) certificate</p>
</li>
<li>
<p><strong>Create Sandstorm Device Private Key:</strong></p>
<pre><code>openssl genrsa -out sandstorm.key 4096
</code></pre>
<p><code>sandstorm.key</code> is the Sandstorm Device Private Key</p>
</li>
<li>
<p><strong>Create Sandstorm Device Certificate Signing Request (CSR) using the copied and edited openssl.cnf file:</strong></p>
<pre><code>openssl req -new -key sandstorm.key -out sandstorm.csr -config openssl.cnf
</code></pre>
<p><code>sandstorm.csr</code> is the Sandstorm Device Certificate Signing Request (CSR)</p>
</li>
<li>
<p><strong>Create and sign the Sandstorm Certificate (Expire in 2 years):</strong></p>
<pre><code>openssl x509 -req -in sandstorm.csr -CA rootCA.pem -CAkey rootCA.key -CAcreateserial -out sandstorm.crt -days 730 -extensions v3_req -extfile openssl.cnf
</code></pre>
<p><code>sandstorm.crt</code> is the Sandstorm Certificate</p>
</li>
<li>
<p><strong>Import the Certificate Authority (CA) Certificate (<code>rootCA.pem</code>) into the browser's that will be using Sandstorm. Some browsers may load grains without this step and ask users to add a security excpetion in order to fully load grains.</strong></p>
</li>
<li>
<p><strong>Copy (FTP/SSH) the Sandstorm Certificate and Sandstorm Private Key to the nginx ssl directory, it may be <code>/etc/nginx/ssl</code></strong>.</p>
</li>
<li>
<p><strong>Change these lines in your nginx conf file to reflect the new Sandstorm Certificate and Private Key filenames</strong>:</p>
<pre><code>ssl_certificate /etc/nginx/ssl/sandstorm.crt;
ssl_certificate_key /etc/nginx/ssl/sandstorm.key;
</code></pre>
</li>
<li>
<p><strong>Restart nginx</strong>:</p>
<pre><code>sudo service nginx restart
</code></pre>
</li>
<li>
<p><strong>Restart Sandstorm:</strong></p>
<pre><code>sudo sandstorm restart
</code></pre>
<p>or</p>
<pre><code>sudo /opt/sandstorm/sandstorm restart
</code></pre>
</li>
</ol>
<p>Created with help from:</p>
<ul>
<li><a href="https://docs.sandstorm.io/en/latest/administering/reverse-proxy/">https://docs.sandstorm.io/en/latest/administering/reverse-proxy/</a></li>
<li><a href="http://datacenteroverlords.com/2012/03/01/creating-your-own-ssl-certificate-authority/">http://datacenteroverlords.com/2012/03/01/creating-your-own-ssl-certificate-authority/</a></li>
<li><a href="https://wiki.cacert.org/FAQ/subjectAltName">https://wiki.cacert.org/FAQ/subjectAltName</a></li>
<li><a href="http://www.codeproject.com/Tips/833087/X-SSL-Certificates-With-Custom-Extensions">http://www.codeproject.com/Tips/833087/X-SSL-Certificates-With-Custom-Extensions</a></li>
<li><a href="http://markmail.org/message/grfu4qkr5v5xttc2">http://markmail.org/message/grfu4qkr5v5xttc2</a></li>
<li><a href="http://blog.loftninjas.org/2008/11/11/configuring-ssl-requests-with-subjectaltname-with-openssl/">http://blog.loftninjas.org/2008/11/11/configuring-ssl-requests-with-subjectaltname-with-openssl/</a></li>
</ul>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../faq/" class="btn btn-neutral float-right" title="Frequently asked questions"/>Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../reverse-proxy/" class="btn btn-neutral" title="Reverse Proxy"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a class="icon icon-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../reverse-proxy/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../faq/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>

</body>
</html>
