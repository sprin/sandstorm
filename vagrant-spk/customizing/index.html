<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Understanding & customizing - Sandstorm</title>
  

  <link rel="shortcut icon" href="../../img/favicon.ico">

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">

  
  <script>
    // Current page data
    var mkdocs_page_name = "Understanding & customizing";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script>
  <script src="../../js/theme.js"></script> 
  <script src="../../analytics.js"></script>

  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Sandstorm</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../..">Home</a>
        
    </li>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Using</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../using/">Overview</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../guided-tour/">Guided tour</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../using/top-bar/">Top bar</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../using/how-it-works/">How it works</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../using/security-practices/">Security practices</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Developing apps</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../developing/">Overview</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../">Overview of vagrant-spk</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../installation/">Installation</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../packaging-tutorial/">Packaging tutorial</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../packaging-tutorial-meteor/">Packaging tutorial (Meteor)</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../developing/publishing-apps/">App publishing guide</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../developing/handbook/">App Developer Handbook</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../developing/auth/">User authentication & permissions</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../developing/path/">Paths and URLs</a>
        
    </li>

        
            
    <li class="toctree-l1 current">
        <a class="current" href="./">Understanding & customizing</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#customizing-and-understanding-vagrant-spk">Customizing and understanding vagrant-spk</a></li>
                
                    <li><a class="toctree-l4" href="#what-the-files-are-for">What the files are for</a></li>
                
                    <li><a class="toctree-l4" href="#example-setups">Example setups</a></li>
                
            
            </ul>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../platform-stacks/">Platform stacks</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../code-dependencies/">Code dependencies</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../services/">Service dependencies</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../developing/web-publishing/">Web publishing</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../developing/http-apis/">Exporting HTTP APIs</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../developing/email-from-apps/">Email from apps</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../design/">vagrant-spk design document</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../developing/troubleshooting/">Troubleshooting</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Developing on raw Sandstorm</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../developing/raw-packaging-guide/">Raw packaging guide</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../developing/raw-python/">Raw integration of Python</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../developing/raw-ruby-on-rails/">Raw integration of Ruby on Rails</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../developing/raw-pure-client-apps/">Raw integration of pure client apps</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Administering</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../administering/">Overview</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../install/">Installation</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../administering/sandcats/">Sandcats dynamic DNS</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../administering/email/">Email</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../administering/demo/">Demo mode</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../administering/backups/">Backups</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../administering/wildcard/">Wildcard hosts</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../administering/reverse-proxy/">Reverse Proxy</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../administering/ssl/">HTTPS & SSL</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../administering/faq/">Frequently asked questions</a>
        
    </li>

        
    </ul>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Sandstorm</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Developing apps &raquo;</li>
        
      
    
    <li>Understanding & customizing</li>
    <li class="wy-breadcrumbs-aside">
      
        
          <a href="https://github.com/sandstorm-io/sandstorm/tree/master/docs" class="icon icon-github"> Edit on GitHub</a>
        
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="customizing-and-understanding-vagrant-spk">Customizing and understanding vagrant-spk</h1>
<h2 id="what-the-files-are-for">What the files are for</h2>
<p><code>vagrant-spk</code> will create a <code>.sandstorm/</code> folder in your repo and set up some
files with some defaults for your app stack.  You will likely need to modify
some of these to adapt their behavior to make the most sense for your app.</p>
<h3 id="global-setupsh">global-setup.sh</h3>
<p>This installs Sandstorm using the official installer script, enables developer
accounts, and stops unneeded services on the VM.  It caches the Sandstorm
bundle to speed up subsequent runs. You should not need to change this script.</p>
<h3 id="setupsh">setup.sh</h3>
<p>This script runs when you set up the VM by <code>vagrant-spk up</code> the first time and
does stack-specific setup, like installing tools or daemons needed to build and
run your app.  <code>vagrant-spk</code> provides some defaults based on commonly-used platform
stacks, but you'll likely want to modify this script as suitable for your package.</p>
<p>This is the ideal place to <code>apt-get install</code> system packages your app relies on,
like:</p>
<ul>
<li>language runtimes (PHP, Node, Python, etc.)</li>
<li>database engines (MySQL, PostgreSQL, Redis, etc.)</li>
<li>frontend web servers (nginx, Apache)</li>
</ul>
<p>and so on.  Please note that this script is run only once for the lifetime of
the VM, and will not be run again when running <code>vagrant-spk dev</code> or starting a
grain.</p>
<p>If you make changes to this script, you should destroy your VM (<code>vagrant-spk destroy</code>)
and rebuild it cleanly from scratch (<code>vagrant-spk up</code>) to make sure your
changes take effect and work as desired.</p>
<p>If you find yourself destroying and creating VMs from scratch frequently,
consider running an instance of <code>apt-cacher-ng</code> on your host to speed up
package downloads.</p>
<h3 id="buildsh">build.sh</h3>
<p>This script runs each time you run <code>vagrant-spk dev</code> before exposing your app
to the Sandstorm server, so you can run it in "dev mode".  Again, <code>vagrant-spk</code>
provides some defaults based on commonly-used patterns in the supported stacks,
but you'll likely need to modify this script to run your package's usual build
flow, since packages use many different workflows and directory structures.</p>
<p>This is the ideal place to invoke anything which is normally part of <em>your app's
build process</em>: anything that you need to transform your project's source code
into a runnable deployment, but explicitly <em>not</em> the project's deployment,
configuration, or user data.</p>
<p>Usually you put things here which should be run again as the result of changes
to your project's source code.  Examples of things you might put here are:</p>
<ul>
<li>Compiling your project from source, for projects written in compiled languages.</li>
<li>Calling <code>composer</code> to install or update PHP dependencies described in your app's <code>composer.json</code></li>
<li>Calling <code>pip</code> to install your app's Python-specific dependencies from the <code>requirements.txt</code> in your app's repository</li>
<li>Calling <code>npm install</code> to install or update npm dependencies from your app's <code>package.json</code></li>
<li>Calling <code>bower install</code> to install or update web/css dependencies described in the app's <code>bower.json</code></li>
<li>Calling <code>gulp</code> to compile and minify SASS/LESS into CSS, or collect javascript into bundles</li>
<li>Minifying dependencies</li>
<li>Collecting various build artifacts or assets into a deployment-ready directory structure</li>
</ul>
<h3 id="launchersh">launcher.sh</h3>
<p>This script will be run every time an instance of your app - aka grain - starts
in Sandstorm.  It is run inside the Sandstorm sandbox.  This script will be run
both when a grain first launches, and when a grain resumes after being
previously shut down.  This script is responsible for <em>launching everything that
your app needs to run</em>.  The thing it should do <em>last</em> is:</p>
<ul>
<li>start a process in the foreground listening on port 8000 for HTTP requests.</li>
</ul>
<p>Frequently this is something like <code>nginx</code> serving static files and reverse
proxying for some other backend service.  You want to run this last because
accepting requests on port 8000 is how you signal to the Sandstorm platform
that your application is completely up and ready for use.  If you do this
before your backend is ready to go, users could get e.g. 502 errors or see a
broken page on first load - a poor first experience.</p>
<p>Other things you probably want to do in this script include:</p>
<ul>
<li>Building folder structures in <code>/var</code>.  <code>/var</code> is the only non-tmpfs folder mounted R/W, and when a grain is first launched, it will start out empty.  It will persist between runs of the same grain, but be unique per app instance.</li>
<li>Preparing a database and running migrations.  You can also manually generate some tables once, place them somewhere under <code>/opt/app</code>, and copy them to <code>/var/lib/mysql</code> if your app takes a while to do migrations, at the potential cost of producing a larger <code>.spk</code>.</li>
<li>Launching other daemons that your app uses (<code>mysqld</code>, <code>redis-server</code>, <code>php5-fpm</code>, <code>uwsgi</code>, etc.)</li>
</ul>
<p>For apps which need the ability to self-modify code or configuration, or which
expect to be able to write data underneath their source tree, you
should create a dangling symlink from
<code>/opt/app/where-your-app-keeps-its-self-modifiable-config.conf</code> to somewhere
under <code>/var</code>, then copy or generate a default configuration to that symlink target under <code>/var</code> in
<code>launcher.sh</code> so your app will find it at runtime.</p>
<p>There's an example of this in the paperwork repository -
<a href="https://github.com/JamborJan/paperwork/blob/cf4b11631e9cda9d45196b1a545a116376e630af/.sandstorm/build.sh#L35"><code>build.sh</code></a>
removes the folder <code>frontend/app/storage</code> and replaces it with a symlink
pointing to <code>/var/storage</code>.  Then,
<a href="https://github.com/JamborJan/paperwork/blob/cf4b11631e9cda9d45196b1a545a116376e630af/.sandstorm/launcher.sh#L16-24"><code>launcher.sh</code></a>
makes sure that <code>/var/storage</code> exists and is populated with the appropriate
subdirectories.</p>
<p>These tend to be unique per-app, so again, <code>vagrant-spk</code> provides appropriate
defaults for common stacks, but you'll likely need to make adjustments for your
app.</p>
<h3 id="sandstorm-fileslist">sandstorm-files.list</h3>
<p>This file is generated by running <code>vagrant-spk dev</code> and using the app.
It contains a list of all files that your app used at runtime.  This
is used to construct a minimal package. See the <a href="../../developing/raw-packaging-guide/">raw packaging
guide</a> for details.</p>
<p>In the fullness of time, we'd like to support a method of generating
<code>sandstorm-files.list</code> that doesn't require the developer to carefully
use every app feature to make sure that e.g. default plugins get
included in the package.</p>
<h3 id="sandstorm-pkgdefcapnp">sandstorm-pkgdef.capnp</h3>
<p>See <a href="../packaging-tutorial/">packaging tutorial</a> for details.</p>
<h3 id="vagrantfile">Vagrantfile</h3>
<p>See <a href="../packaging-tutorial/">packaging tutorial</a> for details.</p>
<h2 id="example-setups">Example setups</h2>
<h3 id="default-setup">Default setup</h3>
<p>Repo: https://github.com/paulproteus/php-app-to-package-for-sandstorm</p>
<p>This example shows how to setup a php + mysql app.</p>
<p><code>setup.sh</code> installs PHP, nginx, and MySQL from the distribution's repository,
then modifies default config files to support the <code>/opt/app</code> layout and run
in the Sandstorm sandbox.</p>
<p><code>build.sh</code> installs/updates composer, and uses composer to install PHP
dependencies.</p>
<p><code>launcher.sh</code> creates a folder structure in <code>/var</code> for MySQL, nginx, and
php5-fpm, creates MySQL tables, then launches the three daemons, checking that
<code>mysqld</code> and <code>php5-fpm</code> are ready to accept requests before launching <code>nginx</code>,
which will listen for requests on port 8000.</p>
<h3 id="paperwork-php-mysql-composer-npm">Paperwork (php, mysql, composer, npm)</h3>
<p>Repo: https://github.com/JamborJan/paperwork</p>
<p><a href="https://github.com/JamborJan/paperwork/blob/master/.sandstorm/setup.sh"><code>setup.sh</code></a>
installs PHP, nginx, nodejs, and npm.  Additionally, it installs some
system-global tools (<code>gulp</code> and <code>bower</code>) with <code>npm</code>.</p>
<p><a href="https://github.com/JamborJan/paperwork/blob/master/.sandstorm/build.sh"><code>build.sh</code></a>
does several things: it installs and updates <code>composer</code>, installs app-specific
<code>npm</code> and <code>bower</code> dependencies from <code>package.json</code> and <code>bower.json</code> manifests
in the repo, and runs <code>gulp</code> to build static assets.</p>
<p><a href="https://github.com/JamborJan/paperwork/blob/master/.sandstorm/launcher.sh"><code>launcher.sh</code></a>
creates the storage folders for notes in <code>/var/storage</code>, which the app will
find because <code>/opt/app/frontend/app/storage</code> (the standard storage location for
Paperwork) is a symlink to <code>/var/storage</code>.  Additionally, the script sets up
the default database, grants permissions, and runs migrations.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../platform-stacks/" class="btn btn-neutral float-right" title="Platform stacks"/>Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../../developing/path/" class="btn btn-neutral" title="Paths and URLs"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a class="icon icon-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../../developing/path/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../platform-stacks/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>

</body>
</html>
